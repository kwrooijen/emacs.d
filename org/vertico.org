* Vertico
:PROPERTIES:
:PACKAGE:  vertico
:STRAIGHT: t
:END:

** General :general:
#+BEGIN_SRC emacs-lisp
(:keymaps 'minibuffer-local-map
          "M-c" #'clipboard-kill-ring-save
          "M-v" #'clipboard-yank

          ;; Navigation
          "C-f" #'scroll-up-command
          "C-b" #'scroll-down-command
          "C-h" #'backward-char
          "C-l" #'forward-char
          "C-j" #'next-line
          "C-k" #'previous-line
          "M-h" #'backward-word
          "M-l" #'forward-word

          ;; Deletion
          "C-d" #'delete-char
          "C-S-d" #'kill-line
          "M-d" #'kill-word

          ;; Other
          "M-]" (lambda() (interactive) (dimmer-restore-all)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "rr" '(vertico-repeat :which-key "Repeat last search"))
#+END_SRC

** Init :init:
#+BEGIN_SRC emacs-lisp
(vertico-mode)
(savehist-mode)
(recentf-mode)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/minibuffer-set-minimum-height ()
  (let ((win (active-minibuffer-window)))
    (when (window-live-p win)
      (with-selected-window win
        (let* ((target 17)
               (delta (- target (window-height))))
          (when (/= delta 0)
            (enlarge-window delta)))))))

(defun kwrooijen/vertico-add-bottom-padding (orig-func height)
  "Add extra padding to Vertico completion window height."
  (funcall orig-func (1+ height)))

(defun kwrooijen/vertico-add-top-padding (orig-fun lines)
  "Add an empty visual line above the Vertico candidate list."
  (funcall
   orig-fun
   (if (or (null lines)
           ;; Don’t mess with alternative UIs; just in case you use them.
           (bound-and-true-p vertico-flat-mode)
           (bound-and-true-p vertico-buffer-mode)
           (bound-and-true-p vertico-grid-mode))
       lines
     ;; Prepend a blank line as an extra ‘candidate line’.
     (cons "\n" lines))))

(defun kwrooijen/hide-minibuffer-prompt ()
  "Visually hide the minibuffer prompt (e.g. \"M-x\", \"Find file:\")."
  (when (minibufferp)

  (let ((inhibit-read-only t))
    (add-text-properties (point-min) (minibuffer-prompt-end)
                         '(display ">> ")))))

(defun kwrooijen/hide-minibuffer-truncation-indicator ()
  (let ((table (or buffer-display-table (make-display-table))))
    (set-display-table-slot
     table 'truncation
     (make-glyph-code ?\  'kwrooijen/darken-fb-face))
    (setq-local buffer-display-table table)))

(advice-add #'vertico--display-candidates :around #'kwrooijen/vertico-add-top-padding)

(advice-add #'vertico--resize-window :around #'kwrooijen/vertico-add-bottom-padding)

(add-hook 'minibuffer-setup-hook #'kwrooijen/hide-minibuffer-truncation-indicator)

;; (add-hook 'minibuffer-setup-hook #'kwrooijen/hide-minibuffer-prompt)
#+END_SRC


** Custom :custom:
#+BEGIN_SRC emacs-lisp
(vertico-count 17)
(vertico-count-format '("%-9s " . "[%s/%s]"))
#+END_SRC

Allow nested minibuffers
#+BEGIN_SRC emacs-lisp
(enable-recursive-minibuffers t)
#+END_SRC


Don't resize minibuffer
#+BEGIN_SRC emacs-lisp
(resize-mini-windows nil)
#+END_SRC

** Hook :hook:
#+BEGIN_SRC emacs-lisp
('minibuffer-setup #'kwrooijen/minibuffer-set-minimum-height)
('minibuffer-setup #'vertico-repeat-save)
#+END_SRC

* Consult
:PROPERTIES:
:PACKAGE:  consult
:STRAIGHT: t
:END:

** Hook :hook:
#+BEGIN_SRC emacs-lisp
(completion-list-mode . consult-preview-at-point-mode)
#+END_SRC

** Init :init:
#+BEGIN_SRC emacs-lisp
(advice-add #'register-preview :override #'consult-register-window)
#+END_SRC

** Custom :custom:

No delays
#+BEGIN_SRC emacs-lisp
(consult-async-refresh-delay 0)
(consult-async-input-debounce 0)
(consult-async-input-throttle 0)
(register-preview-delay nil)
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
  (consult-customize
   consult-line :preview-key 'any)

  (consult-customize
   consult-theme
   consult-buffer
   consult-ripgrep consult-git-grep consult-grep consult-man
   consult-bookmark consult-recent-file consult-xref
   consult-source-bookmark consult-source-file-register
   consult-source-recent-file consult-source-project-recent-file
   kwrooijen/consult-ripgrep-symbol-at-point
   :preview-key "TAB")

(set-face-attribute 'consult-preview-line nil :inherit 'hl-line)
(set-face-attribute 'consult-highlight-match nil :inherit 'bold)
(set-face-attribute 'consult-preview-match nil :inherit 'bold)

(set-face-attribute 'consult-line-number nil :inherit 'font-lock-warning-face)
(set-face-attribute 'consult-line-number-prefix nil :inherit 'font-lock-warning-face)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/consult-ripgrep-symbol-at-point ()
  (interactive)
  (consult-ripgrep nil (thing-at-point 'symbol t)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/minibuffer-disable-hl-line ()
  (with-current-buffer (window-buffer (minibuffer-selected-window))
    (hl-line-mode -1)))

(defun kwrooijen/minibuffer-restore-hl-line ()
  (with-current-buffer (window-buffer (minibuffer-selected-window))
    (hl-line-mode 1)))

(add-hook 'minibuffer-setup-hook #'kwrooijen/minibuffer-disable-hl-line)
(add-hook 'minibuffer-exit-hook #'kwrooijen/minibuffer-restore-hl-line)
#+END_SRC

** General :general:
#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "ss" '(consult-line :which-key "Find in buffer")
  "sp" '(consult-ripgrep :which-key "Grep in Project")
  "sP" '(kwrooijen/consult-ripgrep-symbol-at-point :which-key "Grep symbol in Project")
  "bb" '(consult-buffer :which-key "Switch buffer")
  "fb" '(consult-bookmark :which-key "Open bookmark")
  "ry" '(consult-yank-from-kill-ring :which-key "Kill ring")
  "pp" '(project-switch-project :which-key "Switch project")
  "pf" '(project-find-file :which-key "Find file in project"))
#+END_SRC

* Orderless
:PROPERTIES:
:PACKAGE:  orderless
:STRAIGHT: t
:END:

** Custom :custom:
#+BEGIN_SRC emacs-lisp
(completion-styles '(orderless basic))
(completion-category-defaults nil)
;; (completion-category-overrides '((file (styles . (orderless)))))
(completion-category-overrides '((file (styles partial-completion))))
(completion-category-defaults nil)
(completion-pcm-leading-wildcard t)

(orderless-matching-styles '(orderless-literal orderless-prefixes))
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
(set-face-attribute 'orderless-match-face-0 nil :inherit 'bold :foreground 'unspecified)
(set-face-attribute 'orderless-match-face-1 nil :inherit 'bold :foreground 'unspecified)
(set-face-attribute 'orderless-match-face-2 nil :inherit 'bold :foreground 'unspecified)
(set-face-attribute 'orderless-match-face-3 nil :inherit 'bold :foreground 'unspecified)
#+END_SRC

* Marginalia
:PROPERTIES:
:PACKAGE:  marginalia
:STRAIGHT: t
:END:

** Init :init:
#+BEGIN_SRC emacs-lisp
(marginalia-mode)
#+END_SRC

* Embark
:PROPERTIES:
:PACKAGE:  embark
:STRAIGHT: t
:END:

** General :general:
#+BEGIN_SRC emacs-lisp
(general-define-key
 :keymaps '(minibuffer-mode-map embark-collect-mode-map)
 "M-e" 'embark-act
 "M-a" 'embark-act-all
 "M-b" 'embark-bindings
 "M-i" 'embark-select)
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
(add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))
#+END_SRC

* Embark Consult
:PROPERTIES:
:PACKAGE:  embark-consult
:STRAIGHT: t
:END:
** Hook :hook:
#+BEGIN_SRC emacs-lisp
(embark-collect-mode . consult-preview-at-point-mode)
#+END_SRC

* Wgrep
:PROPERTIES:
:PACKAGE:  wgrep
:STRAIGHT: t
:END:
** General :general:
#+BEGIN_SRC emacs-lisp
(:keymaps 'grep-mode-map
          :states 'normal
          "i" #'wgrep-change-to-wgrep-mode)

(:keymaps 'wgrep-mode-map
          "C-c C-c" #'wgrep-finish-edit)
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
(set-face-attribute 'wgrep-face nil :background 'unspecified :foreground 'unspecified :inherit 'warning)
#+END_SRC

* Project
:PROPERTIES:
:PACKAGE:  project
:STRAIGHT: t
:END:
** Custom :custom:
#+BEGIN_SRC emacs-lisp
(project-switch-commands 'project-find-file)
#+END_SRC
