* Helm
:PROPERTIES:
:PACKAGE: helm
:STRAIGHT: t
:END:

** Improved helm colors
Use the same colors are dired for Helm files.

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/helm-colors-hook ()
  (set-face-attribute 'helm-buffer-directory nil :foreground 'unspecified :background 'unspecified :inherit 'dired-directory)
  (set-face-attribute 'helm-buffer-file nil :foreground 'unspecified :background 'unspecified :inherit 'default)
  (set-face-attribute 'helm-ff-prefix nil :foreground 'unspecified :background 'unspecified)
  ;; (set-face-attribute 'helm-ff-executable nil :foreground 'unspecified :background 'unspecified)
  (set-face-attribute 'helm-ff-directory nil :foreground 'unspecified :background 'unspecified :inherit 'dired-directory)
  (set-face-attribute 'helm-ff-dotted-directory nil :foreground 'unspecified :background 'unspecified :inherit 'dired-directory)
  (set-face-attribute 'helm-ff-file nil :foreground 'unspecified :background 'unspecified :inherit 'default)
  (set-face-attribute 'helm-ff-file-extension nil :foreground 'unspecified :background 'unspecified :inherit 'default)
  (set-face-attribute 'helm-match nil  :foreground 'unspecified :background 'unspecified)
  (set-face-attribute 'helm-header nil :foreground 'unspecified :background 'unspecified)
  (set-face-attribute 'helm-helper nil :foreground 'unspecified :background 'unspecified)
  (set-face-attribute 'helm-M-x-short-doc nil :box 'unspecified :foreground 'unspecified :background 'unspecified :inherit 'font-lock-comment-face))
#+END_SRC

** Better next / previous function
The functions `helm-next-line` and `helm-previous-line` don't jump to
the next source. You have to use `helm-next-source`.

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/helm-next-line-or-next-source ()
  "Go to the next line in Helm buffer. If at the end of the source, go to the next source."
  (interactive)
  (condition-case err
      (let ((pos (helm-get-selection nil nil t)))
        (if (or (null pos) (equal pos (overlay-start helm-selection-overlay)))
            (helm-next-source)
          (helm-next-line)))
    (error (helm-next-line))))

(defun kwrooijen/helm-previous-line-or-previous-source ()
  "Go to the previous line in Helm buffer. If at the beginning of the source, go to the previous source."
  (interactive)
  (condition-case err
      (let ((pos (helm-get-selection nil nil t)))
        (if (or (null pos) (equal pos (overlay-start helm-selection-overlay)))
            (helm-previous-source)
          (helm-previous-line)))
    (error (helm-previous-line))))
#+END_SRC

** Custom Helm M-: (eval-expression)

#+BEGIN_SRC emacs-lisp
(defvar kwrooijen/helm-eval-history nil
  "History for kwrooijen/helm-eval-expression.")

(defun kwrooijen/helm-eval--history-push (expr)
  "Push EXPR into history without duplicating."
  (setq kwrooijen/helm-eval-history
        (cons expr (delete expr kwrooijen/helm-eval-history))))

(defun kwrooijen/helm-eval-expression ()
  (interactive)
  (let ((insert-fn
         (lambda (candidate)
           (helm-set-pattern candidate)
           (helm-force-update))))

    (helm :sources
          (list
           (helm-build-dummy-source "Enter expression"
             :persistent-action insert-fn
             :action (lambda (candidate)
                       (kwrooijen/helm-eval--history-push candidate)
                       (message "%s" (eval (read candidate)))))
           (helm-build-sync-source "Eval history"
             :candidates (lambda () kwrooijen/helm-eval-history)
             :persistent-action insert-fn
             :action (lambda (candidate)
                       (kwrooijen/helm-eval--history-push candidate)
                       (message "%s" (eval (read candidate))))))
          :buffer "*helm eval*")))
#+END_SRC


** Custom :custom:

Show 200 candidates instead of 50 in search results.

#+BEGIN_SRC emacs-lisp
(helm-candidate-number-limit 200)
#+END_SRC

Input in header instead of minibuffer

#+BEGIN_SRC emacs-lisp
(helm-echo-input-in-header-line t)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(helm-find-files-doc-header nil)
#+END_SRC

Show docs when using helm-M-x

#+BEGIN_SRC emacs-lisp
(helm-M-x-show-short-doc t)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(helm-minibuffer-history-key "M-p")
#+END_SRC


** Config :config:


kwrooijen/helm-exit-minibuffer is used to prevent the error "[Display
not Ready]" when pressing return too fast.

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/helm-exit-minibuffer ()
  (interactive)
  (helm-exit-minibuffer))
#+END_SRC


Use helm as default completion framework.

#+BEGIN_SRC emacs-lisp
(helm-mode 1)
#+END_SRC

Don't hide other windows when opening Helm. Open helm with full width
at the bottom.

~helm-split-window-inside-p~ will open the helm buffer in the current
window. This isn't great if the window is small. It also changes the
position of Helm depending on the context. To fix this, use shackle to
always open helm with full width in the bottom.


#+BEGIN_SRC emacs-lisp
(setq helm-split-window-inside-p t)

(push '("\\`\\*helm.*?\\*\\'" :regexp t :align t :ratio 0.3) shackle-rules)
#+END_SRC

Load helm-command to prevent errors

#+BEGIN_SRC emacs-lisp
(require 'helm-command)
#+END_SRC

Hide the cursor in the Helm buffer

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/helm-hide-cursor ()
  (with-helm-buffer
    (setq-local evil-normal-state-cursor '(nil))))

(add-hook 'helm-after-initialize-hook #'kwrooijen/helm-hide-cursor)
#+END_SRC

Remove helm header
#+BEGIN_SRC emacs-lisp
(defun helm-insert-header-from-source (source)
  (let ((name (assoc-default 'name source)))
    (helm-insert-header name "")))
#+END_SRC



** Hooks :hook:

Add `kwrooijen/helm-colors-hook` to `helm-after-initialize` to prevent
custom colors from being overwritten.

#+BEGIN_SRC emacs-lisp
((helm-after-initialize . kwrooijen/helm-colors-hook))
#+END_SRC

** Bindings :general:

#+BEGIN_SRC emacs-lisp
("M-x" 'helm-M-x)
("M-:" 'kwrooijen/helm-eval-expression)

(:keymaps 'helm-find-files-map
          "M-v" 'clipboard-yank
          "C-l" nil)

(:keymaps 'helm-map
          "M-v" #'clipboard-yank
          "C-f" #'helm-next-page
          "C-b" #'helm-previous-page
          "C-h" #'backward-char
          "C-l" #'forward-char
          "M-h" #'backward-word
          "M-l" #'forward-word
          "M-p" #'helm-previous-line
          "M-b" #'backward-word
          "M-l" #'forward-word
          "C-j" #'kwrooijen/helm-next-line-or-next-source
          "C-k" #'kwrooijen/helm-previous-line-or-previous-source
          "TAB" #'helm-execute-persistent-action
          "<tab>" #'helm-execute-persistent-action
          "C-z" #'helm-select-action
          "<return>" #'kwrooijen/helm-exit-minibuffer)

(kwrooijen/leader
  "r r" '(helm-resume :which-key "Helm resume")
  "r y" '(helm-show-kill-ring :which-key "Show kill ring")
  "f f" '(helm-find-files :which-key "Find files")
  "b b" '(helm-buffers-list :which-key "Buffer list")
  "b i" '(kwrooijen/indent-buffer :which-key "Indent Buffer"))
#+END_SRC


** Bingings :general:
#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "ss" '(helm-occur :which-key "Find in buffer"))
#+END_SRC

* Helm Projectile
:PROPERTIES:
:PACKAGE: helm-projectile
:STRAIGHT: t
:END:
** Config :config:

Useful helm projectile functions

#+BEGIN_SRC emacs-lisp
(defun helm-projectile-rg-with-input ()
  (interactive)
  (let ((helm-projectile-set-input-automatically t))
    (helm-projectile-rg)))

(defun helm-projectile-rg-full ()
  (interactive)
  (let ((default-directory (projectile-project-root)))
    (helm-rg "")))

(defun helm-projectile-rg-full-with-input ()
  (interactive)
  (let ((helm-projectile-set-input-automatically t)
        (default-directory (projectile-project-root)))
    (helm-rg (helm-projectile-rg--region-selection))))
#+END_SRC


Start projectile

#+BEGIN_SRC emacs-lisp
(helm-projectile-on)
(projectile-mode +1)
#+END_SRC

*** TODO [PATCH] Overrides in order to add gitmodules as exclusions
https://github.com/bbatsov/helm-projectile/blob/e2e38825c975269a4971df25e79b2ae98929624e/helm-projectile.el#L1000

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/read-gitmodules-paths (file)
 (when (file-exists-p file)
  (with-temp-buffer
    (insert-file-contents file)
    (let (paths)
      (while (re-search-forward "^\\s-*path = \\(.*\\)$" nil t)
        (push (match-string 1) paths))
      (nreverse paths)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun helm-projectile-rg ()
  "Projectile version of `helm-rg'."
  (interactive)
  (if (require 'helm-rg nil t)
      (if (projectile-project-p)
          (let* ((helm-rg-prepend-file-name-line-at-top-of-matches nil)
                 (helm-rg-include-file-on-every-match-line t)
                 (ignored-files (mapcan (lambda (path)
                                          (list "--glob" (concat "!" (glob-quote path))))
                                        (cl-union (projectile-ignored-files-rel)  grep-find-ignored-files)))
                 (ignored-directories (mapcan (lambda (path)
                                                (list "--glob" (concat "!" (glob-quote path) "/**")))
                                              (cl-union (mapcar 'directory-file-name (projectile-ignored-directories-rel))
                                                        (append
                                                         grep-find-ignored-directories
                                                         (kwrooijen/read-gitmodules-paths
                                                          (concat (projectile-project-root) "/.gitmodules"))))))
                 (helm-rg--extra-args `(,@ignored-files ,@ignored-directories)))
            (let ((default-directory (projectile-project-root)))
              (helm-rg (helm-projectile-rg--region-selection)
                       nil)))
        (error "You're not in a project"))
    (when (yes-or-no-p "`helm-rg' is not installed. Install? ")
      (condition-case nil
          (progn
            (package-install 'helm-rg)
            (helm-projectile-rg))
        (error "`helm-rg' is not available.  Is MELPA in your `package-archives'?")))))
#+END_SRC

** Bindings :general:

#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "p p" '(helm-projectile-switch-project :which-key "Switch to Project")
  "p f" '(helm-projectile-find-file :which-key "Find Project file")
  "p F" '(helm-projectile-find-file-in-known-projects :which-key "Find Project file+")
  "s p" '(helm-projectile-rg :which-key "Project Grep")
  "s P" '(helm-projectile-rg-with-input :which-key "Project Grep")
  "s o" '(helm-projectile-rg-full :which-key "Project Grep")
  "s O" '(helm-projectile-rg-full-with-input :which-key "Project Grep"))
#+END_SRC

** Custom :custom:
#+BEGIN_SRC emacs-lisp
(projectile-use-git-grep t)
(helm-projectile-fuzzy-match nil)
(helm-projectile-set-input-automatically nil)
(helm-display-header-line nil))
#+END_SRC

* Helm descbinds
:PROPERTIES:
:PACKAGE: helm-descbinds
:STRAIGHT: t
:END:

* Helm Make
:PROPERTIES:
:PACKAGE: helm-make
:STRAIGHT: t
:END:
** Bindings :general:

#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "c m" '(helm-make :which-key "Make"))
#+END_SRC

* Helm Company
:PROPERTIES:
:PACKAGE: helm-company
:STRAIGHT: t
:END:

** Bindings :general:

#+BEGIN_SRC emacs-lisp
("C-;" 'helm-company)
#+END_SRC

* Helm RG
:PROPERTIES:
:PACKAGE: helm-rg
:STRAIGHT: t
:END:

** Config :config:

Some custom colors for helm-rg to make it less chaotic

#+BEGIN_SRC emacs-lisp
(set-face-attribute 'helm-rg-title-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-error-message nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-extra-arg-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-match-text-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-file-match-face nil :background 'unspecified :foreground 'unspecified :underline 'unspecified :inherit 'kwrooijen/salient-fg-face)
(set-face-attribute 'helm-rg-active-arg-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-base-rg-cmd-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-inactive-arg-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-directory-cmd-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-directory-header-face nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-line-number-match-face nil :background 'unspecified :foreground 'unspecified :underline 'unspecified :inherit 'kwrooijen/faded-fg-face)
(set-face-attribute 'helm-rg-preview-line-highlight nil :background 'unspecified :foreground 'unspecified)
(set-face-attribute 'helm-rg-colon-separator-ripgrep-output-face nil :background 'unspecified :foreground 'unspecified :underline 'unspecified :inherit 'kwrooijen/faded-fg-face)
#+END_SRC

Fix M-b / M-d in helm-rg

#+BEGIN_SRC emacs-lisp
(define-key helm-rg-map (kbd "M-b") 'backward-word)
(define-key helm-rg-map (kbd "M-d") 'kill-word)
#+END_SRC


*** TODO [PATCH] Overrides to remove header from helm-rg
https://github.com/cosmicexplorer/helm-rg/blob/ee0a3c09da0c843715344919400ab0a0190cc9dc/helm-rg.el#L1132

#+BEGIN_SRC emacs-lisp
(defun helm-rg--make-process-from-argv (argv)
  (let* ((real-proc (make-process
                     :name helm-rg--process-name
                     :buffer helm-rg--process-buffer-name
                     :command argv
                     :noquery t))
         (helm-src-name
          (format "argv: %s" (helm-rg--join " " argv))))
    ;; TODO MAKE THIS OPTIONAL
    ;; (helm-attrset 'name helm-src-name)
    (set-process-query-on-exit-flag real-proc nil)
    real-proc))
#+END_SRC


* Helm Bookmark
:PROPERTIES:
:PACKAGE:  helm-bookmark
:END:

** Custom :custom:
#+BEGIN_SRC emacs-lisp
(bookmark-default-file (file-name-concat kwrooijen/emacs-directory "db/bookmark-default.el")))
(bookmark-file (file-name-concat kwrooijen/emacs-directory "db/bookmark-default.el")))
#+END_SRC

** General :general:
#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "f b" '(helm-bookmarks :which-key "Bookmarks"))
#+END_SRC


* Helm Occur
:PROPERTIES:
:PACKAGE: helm-occur
:END:
** Config :config:
#+BEGIN_SRC emacs-lisp

;; [PULL REQUEST]

(defcustom helm-occur-lineno-format "%s:"
"Helm occur line number format, displayed left of the candidate."
:type 'string)

(defun helm-occur-transformer (candidates source)
  "Return CANDIDATES prefixed with line number."
  (cl-loop with buf = (helm-get-attr 'buffer-name source)
           for c in candidates
           for bfname = (buffer-file-name (get-buffer buf))
           for disp-linum = (when (string-match helm-occur--search-buffer-regexp c)
                              (let ((linum (match-string 1 c))
                                    (disp (match-string 2 c)))
                                (list
                                 linum
                                 (format "%s%s"
                                         (propertize
                                          (format helm-occur-lineno-format  linum)
                                          'face 'helm-grep-lineno
                                          'help-echo bfname
                                          'helm-grep-fname bfname)
                                         disp))))
           for linum = (car disp-linum)
           for disp = (cadr disp-linum)
           when (and disp (not (string= disp "")))
           collect (cons disp (string-to-number linum))))

;; Custom

(setq helm-occur-lineno-format "%4s: ")

(kwrooijen/reset-inherit-face! 'helm-grep-lineno 'kwrooijen/faded-fg-face)
#+END_SRC
