* Vertico
:PROPERTIES:
:PACKAGE:  vertico
:STRAIGHT: t
:END:

** Config :config:


#+BEGIN_SRC emacs-lisp
;; Disabled: vertico-next-group breaks consult-ripgrep
(defun vertico-next-group (&optional n) (interactive))
#+END_SRC


** General :general:
#+BEGIN_SRC emacs-lisp
(:keymaps 'minibuffer-local-map
          "M-c" #'clipboard-kill-ring-save
          "M-v" #'clipboard-yank

          ;; Navigation
          "C-f" #'scroll-up-command
          "C-b" #'scroll-down-command
          "C-h" #'backward-char
          "C-l" #'forward-char
          "C-j" #'next-line
          "C-k" #'previous-line
          "M-h" #'backward-word
          "M-l" #'forward-word

          ;; Deletion
          "C-d" #'delete-char
          "C-S-d" #'kill-line
          "M-d" #'kill-word

          ;; Other
          "M-]" (lambda() (interactive) (dimmer-restore-all)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "rr" '(vertico-repeat :which-key "Repeat last search"))
#+END_SRC

** Init :init:
#+BEGIN_SRC emacs-lisp
(vertico-mode)
(savehist-mode)
(recentf-mode)
#+END_SRC


** Custom :custom:
#+BEGIN_SRC emacs-lisp
(vertico-count 17)
(vertico-count-format '("%-9s " . "[%s/%s]"))
#+END_SRC

Allow nested minibuffers
#+BEGIN_SRC emacs-lisp
(enable-recursive-minibuffers t)
#+END_SRC

** Hook :hook:
#+BEGIN_SRC emacs-lisp
('minibuffer-setup #'vertico-repeat-save)
#+END_SRC

* Consult
:PROPERTIES:
:PACKAGE:  consult
:STRAIGHT: t
:END:

** Hook :hook:
#+BEGIN_SRC emacs-lisp
(completion-list-mode . consult-preview-at-point-mode)
#+END_SRC

** Init :init:
#+BEGIN_SRC emacs-lisp
(advice-add #'register-preview :override #'consult-register-window)
#+END_SRC

** Custom :custom:

No delays
#+BEGIN_SRC emacs-lisp
(consult-async-refresh-delay 0)
(consult-async-input-debounce 0)
(consult-async-input-throttle 0)
(register-preview-delay nil)
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
(consult-customize
 consult-line :preview-key 'any)

(consult-customize
 consult-theme
 consult-buffer
 consult-ripgrep consult-git-grep consult-grep consult-man
 consult-bookmark consult-recent-file consult-xref
 consult-source-bookmark consult-source-file-register
 consult-source-recent-file consult-source-project-recent-file
 kwrooijen/consult-ripgrep-symbol-at-point
 consult-notes-search-in-all-notes
 :preview-key "TAB")
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/consult-buffer-pair-modified (buffer)
  "Like `consult--buffer-pair' but propertize modified file buffers with the error face."
  (let ((name (buffer-name buffer)))
    (cons (if (and (buffer-modified-p buffer)
                   (buffer-file-name buffer))
              (propertize name 'face 'embellish-theme-error-fg-face)
            name)
          buffer)))

(setq consult-source-buffer
      (plist-put consult-source-buffer :items
                 (lambda ()
                   (consult--buffer-query :sort 'visibility
                                          :as #'kwrooijen/consult-buffer-pair-modified))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/consult-ripgrep-symbol-at-point ()
  (interactive)
  (consult-ripgrep nil (thing-at-point 'symbol t)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/minibuffer-disable-hl-line ()
  (with-current-buffer (window-buffer (minibuffer-selected-window))
    (hl-line-mode -1)))

(defun kwrooijen/minibuffer-restore-hl-line ()
  (with-current-buffer (window-buffer (minibuffer-selected-window))
    (hl-line-mode 1)))

(add-hook 'minibuffer-setup-hook #'kwrooijen/minibuffer-disable-hl-line)
(add-hook 'minibuffer-exit-hook #'kwrooijen/minibuffer-restore-hl-line)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/consult-peek-buffer ()
  "Temporarily peek at another buffer using popwin, restoring layout on quit."
  (interactive)
  (let* ((selected (consult--multi consult-buffer-sources
                                   :require-match
                                   (confirm-nonexistent-file-or-buffer)
                                   :prompt "Switch to: "
                                   :history 'consult--buffer-history
                                   :sort nil
                                   :state (lambda (_action _match))))
         (popwin-fn (lambda (buffer)
                      (popwin:display-buffer-1
                       buffer
                       :default-config-keywords '(:position left :width 0.5))))
         (type (when selected (plist-get (cdr selected) :name))))
    (when selected
      (pcase type
        ("Buffer"
         (funcall popwin-fn (car selected)))

        ("Bookmark"
         (let ((bookmark-buffer nil))
           (bookmark-jump (car selected) popwin-fn)))

        ("File"
         (funcall popwin-fn (find-file-noselect (car selected))))))))
#+END_SRC

Project find files

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/consult-project-find-file ()
  "Find a project file using `rg --files`, excluding .git/ but keeping .gitignore."
  (interactive)
  (let* ((root (project-root (project-current t)))
         (default-directory root)
         (rg (executable-find "rg")))
    (unless rg
      (user-error "ripgrep (rg) not found in PATH"))
    (let* ((files (process-lines rg
                                 "--files"
                                 "--color=never"
                                 "--hidden"
                                 "--follow"
                                 "--glob" "!.git/**"))
           (choice (consult--read files
                                  :prompt "Project file: "
                                  :sort nil
                                  :category 'file
                                  :history 'file-name-history)))
      (find-file (expand-file-name choice root)))))
#+END_SRC



** General :general:
#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "ss" '(consult-line :which-key "Find in buffer")
  "sp" '(consult-ripgrep :which-key "Grep in Project")
  "sP" '(kwrooijen/consult-ripgrep-symbol-at-point :which-key "Grep symbol in Project")
  "bb" '(consult-buffer :which-key "Switch buffer")
  "bp" '(kwrooijen/consult-peek-buffer :which-key "Peek buffer")
  "fb" '(consult-bookmark :which-key "Open bookmark")
  "ry" '(consult-yank-from-kill-ring :which-key "Kill ring")
  "pp" '(project-switch-project :which-key "Switch project")
  "pf" '(kwrooijen/consult-project-find-file :which-key "Find file in project"))
#+END_SRC

* Orderless
:PROPERTIES:
:PACKAGE:  orderless
:STRAIGHT: t
:END:

** Custom :custom:
#+BEGIN_SRC emacs-lisp
(completion-styles '(orderless basic))
(completion-category-defaults nil)
(completion-category-overrides '((file (styles partial-completion))))
(completion-pcm-leading-wildcard t)

(orderless-matching-styles '(orderless-literal orderless-prefixes))
#+END_SRC

* Marginalia
:PROPERTIES:
:PACKAGE:  marginalia
:STRAIGHT: t
:END:

** Init :init:
#+BEGIN_SRC emacs-lisp
(marginalia-mode)
#+END_SRC


* Embark
:PROPERTIES:
:PACKAGE:  embark
:STRAIGHT: t
:END:

** General :general:
#+BEGIN_SRC emacs-lisp
(general-define-key
 :keymaps '(minibuffer-mode-map embark-collect-mode-map)
 "M-e" 'embark-act
 "M-a" 'embark-act-all
 "M-b" 'embark-bindings
 "M-i" 'embark-select)
#+END_SRC

** Config :config:
#+BEGIN_SRC emacs-lisp
(add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))
#+END_SRC


* Embark Consult
:PROPERTIES:
:PACKAGE:  embark-consult
:STRAIGHT: t
:END:

** Hook :hook:
#+BEGIN_SRC emacs-lisp
(embark-collect-mode . consult-preview-at-point-mode)
#+END_SRC


* Wgrep
:PROPERTIES:
:PACKAGE:  wgrep
:STRAIGHT: t
:END:

** General :general:
#+BEGIN_SRC emacs-lisp
(:keymaps 'grep-mode-map
          :states 'normal
          "i" #'wgrep-change-to-wgrep-mode)

(:keymaps 'wgrep-mode-map
          "C-c C-c" #'wgrep-finish-edit)
#+END_SRC


* Project
:PROPERTIES:
:PACKAGE:  project
:STRAIGHT: t
:END:

** Custom :custom:
#+BEGIN_SRC emacs-lisp
(project-switch-commands 'project-find-file)
#+END_SRC
