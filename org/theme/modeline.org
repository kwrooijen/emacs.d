#+BEGIN_SRC emacs-lisp
;; ----------------------------------------
;; Faces
;; ----------------------------------------

(defface kwrooijen/modeline-border
  '()
  "Face for the active window border."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-border-inactive
  '((t (:inherit kwrooijen/darken-fb-face)))
  "Face for the inactive window border."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-evil
  '((t (:height 1.0)))
  "Face for evil state indicator."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-winum
  '((t (:height 1.0)))
  "Face for winum number."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-buffer
  '((t (:height 1.0)))
  "Face for buffer/file name."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-scroll
  '((t (:height 1.0)))
  "Face for scroll percentage indicator."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-git-branch
  '((t (:height 1.0
        :inherit success)))
  "Face for Git branch."
  :group 'kwrooijen/modeline)

(defface kwrooijen/modeline-major-mode
  '((t (:height 1.0)))
  "Face for major mode text."
  :group 'kwrooijen/modeline)

;; ----------------------------------------
;; Raise helper (core of vertical centering)
;; ----------------------------------------

(defvar kwrooijen/modeline-raise 0.20)

(defun kwrooijen/modeline-r (s face)
  "Apply face and vertical raise to a modeline string."
  (propertize s 'face face 'display `(raise ,kwrooijen/modeline-raise)))

(kwrooijen/reset-inherit-face!
 'mode-line           'kwrooijen/darken-bg-face
 'mode-line-active    'kwrooijen/darken-bg-face
 'mode-line-inactive  'kwrooijen/darken-bg-face
 'mode-line-highlight 'unspecified)

(set-face-attribute 'kwrooijen/modeline-border nil :height 1.5)
(set-face-attribute 'kwrooijen/modeline-border-inactive nil :height 1.5)

;; ----------------------------------------
;; Border characters
;; ----------------------------------------

(defvar kwrooijen/modeline-active-border "▎")
(defvar kwrooijen/modeline-inactive-border "▎")

(defun kwrooijen/modeline-win-focus-border (&optional force)
  "Show a border only when the window is active."
  (if (or force (eq (selected-window) kwrooijen/modeline-selected-window))
      (propertize kwrooijen/modeline-active-border 'face 'kwrooijen/modeline-border)
    (propertize kwrooijen/modeline-inactive-border 'face 'kwrooijen/modeline-border-inactive)))

;; ----------------------------------------
;; Track active window
;; ----------------------------------------

(defun kwrooijen/modeline--set-selected-window (&rest _)
  (unless (minibuffer-window-active-p (selected-window))
    (setq kwrooijen/modeline-selected-window (selected-window))))

(add-hook 'post-command-hook #'kwrooijen/modeline--set-selected-window)

;; ----------------------------------------
;; Segments
;; ----------------------------------------

;; Evil state
(defun kwrooijen/modeline-evil-tag ()
  (when (bound-and-true-p evil-local-mode)
    (let* ((state evil-state)
           (tag
            (upcase
             (pcase state
               ('normal  " N ")
               ('insert  " I ")
               ('visual  " V ")
               ('replace " R ")
               (_ (substring (symbol-name state) 0 1)))))
           (face
            (pcase state
              ('normal  'success)
              ('visual  'region)
              ('insert  'warning)
              ('replace 'error)
              (_ 'kwrooijen/modeline-evil))))
      (kwrooijen/modeline-r tag face))))


;; Winum (bold when active)
(defun kwrooijen/modeline-winum ()
  (when (bound-and-true-p winum-mode)
    (let* ((num-str (format "%d" (or (winum-get-number) 1)))
           (face (if (eq (selected-window) kwrooijen/modeline-selected-window)
                     `(:inherit kwrooijen/modeline-winum :weight bold)
                   'kwrooijen/modeline-winum)))
      (kwrooijen/modeline-r num-str face))))

;; Git branch
(defun kwrooijen/modeline-git-branch ()
  ""
  (when-let ((branch (magit-get-current-branch)))
    (kwrooijen/modeline-r
     (format " %s" branch)
     'kwrooijen/modeline-git-branch)))

;; Scroll indicator
(defun kwrooijen/modeline-scroll ()
  (kwrooijen/modeline-r
   (cond
    ((eq (point) (point-min)) "Top")
    ((eq (point) (point-max)) "Bot")
    (t (format "%d％"
               (/ (* 100 (1- (line-number-at-pos)))
                  (count-lines (point-min) (point-max))))))
   'kwrooijen/modeline-scroll))

(defun kwrooijen/modeline-line-col ()
  (kwrooijen/modeline-r
   (format "%d:%d"
           (line-number-at-pos)
           (current-column))
   'kwrooijen/modeline-scroll)) ;; same style as scroll, adjust if you want

(defun kwrooijen/modeline-buffer-name ()
  (let* ((dirty? (buffer-modified-p))
         (face   (if dirty?
                     `(:foreground ,(face-attribute 'kwrooijen/warning-fg-face :foreground))
                   'kwrooijen/modeline-buffer)))
    (kwrooijen/modeline-r "%b" face)))
#+END_SRC

#+BEGIN_SRC emacs-lisp
;; ----------------------------------------
;; Build modeline
;; ----------------------------------------

(defun kwrooijen/mode-line ( )
  (let* ((left
          (list
           (kwrooijen/modeline-win-focus-border)
           " "
           (kwrooijen/modeline-winum)
           " "
           (kwrooijen/modeline-evil-tag)
           " "
           (kwrooijen/modeline-buffer-name)
           "  "
           (kwrooijen/modeline-line-col)
           " "
           (kwrooijen/modeline-scroll)))

         (active? (eq (selected-window) kwrooijen/modeline-selected-window))
         (mode-face (if active?
                        `(:inherit kwrooijen/modeline-major-mode :weight bold)
                      'kwrooijen/modeline-major-mode))

         (right
          (list
           (kwrooijen/modeline-git-branch)
           "  "
           (kwrooijen/modeline-r "%m  " mode-face))))

    (concat
     (format-mode-line left)
     (propertize
      " "
      'display
      `((space :align-to
               (- (+ right right-fringe right-margin)
                  ,(string-width (format-mode-line right))))))
     (format-mode-line right))))

(setq-default mode-line-format
              '((:eval (kwrooijen/mode-line))))
#+END_SRC


* Helm

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/modeline-helm-candidates()
  (kwrooijen/modeline-r
   (with-helm-buffer
     (format "[%s/%s]"
             (- (line-number-at-pos) 1)
             (helm-get-candidate-number 'in-current-source)))
   'default))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/helm-buffer ()
  (kwrooijen/modeline-r
   (capitalize
    (replace-regexp-in-string "-" " "
                              (replace-regexp-in-string "\\*" "" (buffer-name))))
   'warning))
#+END_SRC


#+BEGIN_SRC emacs-lisp
(with-eval-after-load 'helm
  (defun helm-display-mode-line (source &optional force)
    "Fully custom Helm modeline."
    ;; Override the whole mode-line-format
    (setq mode-line-format
          (let* ((left
                  (list
                   (kwrooijen/modeline-win-focus-border t)
                   " "
                   ;; (kwrooijen/buffer-capitalize (kwrooijen/modeline-buffer-name))
                   (kwrooijen/helm-buffer)
                   " "
                   '(:eval
                     (kwrooijen/modeline-helm-candidates)
                     )))
                 (active? (eq (selected-window) kwrooijen/modeline-selected-window))
                 (mode-face (if active?
                                `(:inherit kwrooijen/modeline-major-mode :weight bold)
                              'kwrooijen/modeline-major-mode))
                 (right
                  (list)))
            (concat
             (format-mode-line left)
             (propertize
              " "
              'display
              `((space :align-to
                       (- (+ right right-fringe right-margin)
                          ,(string-width (format-mode-line right))))))
             (format-mode-line right))))))
#+END_SRC
