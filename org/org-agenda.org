* Org Agenda
:PROPERTIES:
:PACKAGE:  org-agenda
:END:

** Config :config:

Automatically save any org buffers when making changes in org agenda.

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/agenda-org-save-all-org-buffers ()
  (when (equal major-mode 'org-agenda-mode)
    ;; TODO Inhibit messages
    (org-save-all-org-buffers))
  (when (equal major-mode 'org-mode)
    ;; TODO Inhibit messages
    (save-buffer)))

(add-hook 'org-after-todo-state-change-hook #'kwrooijen/agenda-org-save-all-org-buffers)
(add-hook 'org-clock-in-hook                #'kwrooijen/agenda-org-save-all-org-buffers)
(add-hook 'org-clock-out-hook               #'kwrooijen/agenda-org-save-all-org-buffers)

;; Save org buffers after org-clock-multi operations
(advice-add 'org-clock-multi-clock-in      :after #'org-save-all-org-buffers)
(advice-add 'org-clock-multi-clock-out     :after #'org-save-all-org-buffers)
(advice-add 'org-clock-multi-clock-out-all :after #'org-save-all-org-buffers)
(advice-add 'org-clock-multi-clock-cancel  :after #'org-save-all-org-buffers)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-agenda-clockreport-widen (&rest _)
  (let* ((dir (file-truename (expand-file-name "~/Documents/org/todos/client/"))))
    (dolist (buf (buffer-list))
      (with-current-buffer buf
        (when-let ((f (buffer-file-name buf)))
          (setq f (file-truename f))
          (when (and (string-prefix-p dir f)
                     (string-match-p "\\.org\\'" f))
            (widen)))))))

(advice-add 'org-agenda-clockreport-mode :before
            #'kwrooijen/org-agenda-clockreport-widen)
#+END_SRC


#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-clock-multi-skip-unless-clocked ()
  "Skip function for agenda: skip unless heading is in org-clock-multi-clocks."
  (let ((dominated t))
    (when org-clock-multi-clocks
      (let* ((file (buffer-file-name))
             (id (org-entry-get nil "CLOCK_MULTI_ID")))
        (when (and file id)
          (let ((key (cons file id)))
            (when (org-clock-multi--find-clock-by-key key)
              (setq dominated nil))))))
    (when dominated
      (org-end-of-subtree t))))

(setq org-agenda-custom-commands
      '(("c" "My custom agenda"
         ((agenda "")
          (tags-todo "work")))
        ("D" "Done tasks"
         todo "DONE")
        ("k" "Currently clocked"
         ((alltodo "" ((org-agenda-skip-function
                        #'kwrooijen/org-clock-multi-skip-unless-clocked))))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-agenda-done ()
  (interactive)
  (org-agenda nil "D"))
#+END_SRC

Custom loading bar for work.
#+BEGIN_SRC emacs-lisp


(defun kwrooijen/org-agenda-loading-bar ()
  "Return a textual loading bar based on today's clocked minutes."
  (let* ((max 480.0)
         (current (float (kwrooijen/org-clock-clocked-today)))
         (ratio (min 1.0 (/ current max)))
         (width 30)
         (filled (round (* width ratio)))
         (empty (- width filled))
         (percent (round (* 100 ratio))))
    (format
     "%s\n\nWork Progress: [%s%s] %d%% (%d / 480 min)\n\n%s\n\n"
     (make-string (- (window-width) 1) ?─)
     (make-string filled ?█)
     (make-string empty ?░)
     percent
     (round current)
     (make-string (- (window-width) 1) ?─))))

(defun kwrooijen/org-agenda-insert-loading-bar ()
  "Insert loading bar at the top of the agenda buffer."
  ;; TODO only when current day is mon - fri
  ;; (when (derived-mode-p 'org-agenda-mode)
  ;;   (let ((inhibit-read-only t))
  ;;     (goto-char (point-min))
  ;;     (insert (kwrooijen/org-agenda-loading-bar))))
)

(add-hook 'org-agenda-finalize-hook
          #'kwrooijen/org-agenda-insert-loading-bar)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-client-names ()
  "Return a list of client names derived from org files."
  (let ((dir (expand-file-name "~/Documents/org/todos/client/")))
    (mapcar #'file-name-base
            (directory-files dir nil "\\.org$"))))

(defun kwrooijen/org-set-clockreport-match (client)
  "Update only :match in `org-agenda-clockreport-parameter-plist`."
  (interactive
   (list (completing-read "Clockreport match: " (append (kwrooijen/org-client-names) '("work")) nil nil)))
  (setq org-agenda-clockreport-parameter-plist
        (plist-put org-agenda-clockreport-parameter-plist
                   :match
                   client))
  (org-agenda-redo))
#+END_SRC


#+BEGIN_SRC emacs-lisp
(evil-set-initial-state 'org-agenda-mode 'normal)
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-agenda-edit-subtree ()
  (interactive)
  (org-agenda-goto)
  (org-narrow-to-subtree)
  (evil-normal-state)
  (with-current-buffer "*Org Agenda*"
    (org-agenda-redo)))

(evil-define-key 'normal org-agenda-mode-map (kbd "<tab>") #'kwrooijen/org-agenda-edit-subtree)
#+END_SRC

Add functionality to toggle habits in agenda.

#+BEGIN_SRC emacs-lisp
(defvar kwrooijen/org-habit-shown-p t)

(defun kwrooijen/org-habit-toggle ()
  (interactive)
  (setq kwrooijen/org-habit-shown-p (not kwrooijen/org-habit-shown-p))
  (org-agenda-redo))

(require 'org-habit)
#+END_SRC

** Custom :custom:

Adjsut the org agenda format. We add `EFFORT` (`[%e]`) to the `agenda`
view. (NOTE: Removed `%e` for now, to see how we can organize it nicely

#+BEGIN_SRC emacs-lisp
(setq org-agenda-prefix-format
 '((agenda . "[%-5e] %-12:c%?-12t% s")
   (todo . " %i %-12:c")
   (tags . " %i %-12:c")
   (search . " %i %-12:c")))
#+END_SRC

Don't show scheduled TODOs if they have been done today

#+BEGIN_SRC emacs-lisp
(org-agenda-todo-ignore-scheduled 'future)
#+END_SRC

Org agenda table, include ASANA in header for ticket ids

#+BEGIN_SRC emacs-lisp
(org-agenda-clockreport-parameter-plist
 (list :maxlevel 2
       :narrow nil
       :properties '("ASANA")
       :match "+work"
       :indent nil
       :tcolumns 1))
#+END_SRC

List of keywords which a TODO heading can have.

#+BEGIN_SRC emacs-lisp
(org-todo-keywords '((sequence
                      "TODO(t)"
                      "IN PROGRESS(p)"
                      "WAITING(w)"
                      "|"
                      "CANCELLED(c!)"
                      "DONE(d!)")))
#+END_SRC

Set the faces for specific org keywords

#+BEGIN_SRC emacs-lisp
(org-todo-keyword-faces
      '(("TODO"        . (:inherit kwrooijen/salient-fg-face))
        ("IN PROGRESS" . (:inherit kwrooijen/popout-fg-face))
        ("WAITING"     . (:inherit kwrooijen/faded-fg-face))
        ("DONE"        . (:inherit org-done))
        ("CANCELLED"   . (:inherit org-done))))
#+END_SRC


Customize agenda renderer to optionally filter out habits.

#+BEGIN_SRC emacs-lisp
(org-agenda-skip-function-global
 (lambda ()
   (when (and (org-is-habit-p) (not kwrooijen/org-habit-shown-p))
     (org-agenda-skip-entry-if 'todo 'any))))
#+END_SRC



** General :general:
#+BEGIN_SRC emacs-lisp
(kwrooijen/leader
  "aa" '(org-agenda-list :which-key "Org Agenda")
  "ao" '(org-agenda :which-key "Org Commands")
  "at" '(org-todo-list :which-key "Org Todos")
  "ad" '(kwrooijen/org-agenda-done :which-key "Org Done")
  "ac" '(org-capture :which-key "Org Capture"))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(general-define-key
:states '(normal)
:keymaps 'org-agenda-mode-map
  (kbd "TAB") #'kwrooijen/org-agenda-edit-subtree
  (kbd "RET") #'org-agenda-switch-to
  (kbd "SPC") #'org-agenda-show-and-scroll-up

  (kbd "C-k") #'org-agenda-kill
  (kbd "C-n") #'org-agenda-next-line
  (kbd "C-p") #'org-agenda-previous-line
  ;; "C-_" #'org-agenda-undo
  "!" #'org-agenda-toggle-deadlines
  "#" #'org-agenda-dim-blocked-tasks
  "$" #'org-agenda-archive
  "%" #'org-agenda-bulk-mark-regexp
  "+" #'org-agenda-priority-up
  "," #'org-agenda-priority
  "-" #'org-agenda-priority-down
  "." #'org-agenda-goto-today
  "/" #'org-agenda-filter
  ":" #'org-agenda-set-tags
  ";" #'kwrooijen/org-set-clockreport-match
  "<" #'org-agenda-filter-by-category
  "=" #'org-agenda-filter-by-regexp
   ">" #'org-agenda-date-prompt
  "?" #'org-agenda-show-the-flagging-note
  "A" #'org-agenda-append-agenda
  "B" #'org-agenda-bulk-action
  "C" #'org-agenda-convert-date
  "D" #'org-agenda-toggle-diary
  "E" #'org-agenda-entry-text-mode
  "F" #'org-agenda-follow-mode
  "G" #'org-agenda-toggle-time-grid
  "H" #'org-agenda-holidays
  "I" #'org-clock-multi-agenda-clock-in
  "J" #'org-clock-multi-agenda-clock-goto
  "K" #'org-habit-toggle-display-in-agenda
  "L" #'org-agenda-recenter
  "N" #'org-agenda-next-item
  "O" #'org-clock-multi-agenda-clock-out
  "P" #'org-agenda-previous-item
  "Q" #'org-agenda-Quit
  "R" #'org-agenda-clockreport-mode
  "S" #'org-agenda-sunrise-sunset
  "T" #'org-agenda-show-tags
  (kbd "M-m") #'org-agenda-bulk-unmark
  (kbd "M-M") #'org-agenda-bulk-unmark-all
  (kbd "C-o") #'org-clock-multi-agenda-clock-out-all
  "m" #'org-agenda-bulk-mark
  "M" #'org-agenda-bulk-mark-all
  "X" #'org-clock-multi-agenda-clock-cancel
  "[" #'org-agenda-manipulate-query-add
  "\\" #'org-agenda-filter-by-tag
  "]" #'org-agenda-manipulate-query-subtract
  "^" #'org-agenda-filter-by-top-headline
  "_" #'org-agenda-filter-by-effort
  "a" #'org-agenda-archive-default-with-confirmation
  "b" #'org-agenda-earlier
  "c" #'org-agenda-goto-calendar
  "d" #'org-agenda-day-view
  "e" #'org-agenda-set-effort
  "f" #'org-agenda-later
  "g" #'org-agenda-redo-all
  "H" #'org-agenda-holidays
  "i" #'org-agenda-diary-entry
  "n" #'org-agenda-goto-date
  "p" #'org-agenda-capture
  "L" #'org-agenda-log-mode
  "o" #'org-agenda-month-view

  "k" #'org-agenda-previous-line
  "j" #'org-agenda-next-line
  "l" #'evil-forward-char
  "h" #'evil-backward-char

  "q" #'org-agenda-quit
  "r" #'org-agenda-redo
  "s" #'org-save-all-org-buffers
  "t" #'org-agenda-todo
  "u" #'org-agenda-undo
  "U" #'org-agenda-redo
  "v" #'org-agenda-view-mode-dispatch
  "w" #'org-agenda-week-view
  "x" #'org-agenda-exit
  "y" #'org-agenda-year-view
  "z" #'org-agenda-add-note
  "{" #'org-agenda-manipulate-query-add-re
  "|" #'org-agenda-filter-remove-all
  "}" #'org-agenda-manipulate-query-subtract-re
  "~" #'org-agenda-limit-interactively
  (kbd "DEL") #'org-agenda-show-scroll-down)
#+END_SRC


* Org Capture
:PROPERTIES:
:PACKAGE:  org-capture
:END:

** Init :init:

Read org capture templates from other file.

#+BEGIN_SRC emacs-lisp
(kwrooijen/find-and-load-file "~/.dotfiles/org-capture-templates.el")
#+END_SRC


* Calendar
:PROPERTIES:
:PACKAGE:  calendar
:END:

** Config :config:

#+BEGIN_SRC emacs-lisp
(evil-set-initial-state 'calendar-mode 'normal)
#+END_SRC

** General :general:
#+BEGIN_SRC emacs-lisp
(general-define-key
 :states '(normal)
 :keymaps 'calendar-mode-map
 (kbd "RET") #'org-calendar-select
 "C-@" #'calendar-set-mark
 "C-a" #'calendar-beginning-of-week
 "h" #'calendar-backward-day
 "l" #'calendar-forward-day
 "j" #'calendar-forward-week
 "k" #'calendar-backward-week
 "C-e" #'calendar-end-of-week
 "C-l" #'calendar-recenter
 "C-v" #'calendar-scroll-left-three-months
 (kbd "SPC") #'scroll-other-window
 "-" #'negative-argument
 "." #'calendar-goto-today
 "<" #'calendar-scroll-right
 ">" #'calendar-scroll-left
 "?" #'calendar-goto-info-node
 "D" #'diary-view-other-diary-entries
 "M" #'calendar-lunar-phases
 "S" #'calendar-sunrise-sunset
 "[" #'calendar-backward-year
 "]" #'calendar-forward-year
 "a" #'calendar-list-holidays
 "c" #'org-calendar-goto-agenda
 "d" #'diary-view-entries
 ;; "h" #'calendar-cursor-holidays
 "m" #'diary-mark-entries
 "o" #'calendar-other-month
 "q" #'calendar-exit
 "s" #'diary-show-all-entries
 "u" #'calendar-unmark
 "x" #'calendar-mark-holidays
 "{" #'calendar-backward-month
 "}" #'calendar-forward-month
 ;; "DEL" #'scroll-other-window-down
 ;; "S-SPC" #'scroll-other-window-down
 ;; "C-SPC" #'calendar-set-mark

 (kbd "C-c C-l") #'calendar-redraw

 (kbd "C-x C-x") #'calendar-exchange-point-and-mark
 (kbd "C-x <") #'calendar-scroll-right
 (kbd "C-x >") #'calendar-scroll-left
 (kbd "C-x [") #'calendar-backward-year
 (kbd "C-x ]") #'calendar-forward-year

 (kbd "M-<") #'calendar-beginning-of-year
 (kbd "M-=") #'calendar-count-days-region
 (kbd "M->") #'calendar-end-of-year
 (kbd "M-a") #'calendar-beginning-of-month
 (kbd "M-e") #'calendar-end-of-month
 (kbd "M-v") #'calendar-scroll-right-three-months
 (kbd "M-{") #'calendar-backward-month
 (kbd "M-}") #'calendar-forward-month

 "A a" #'appt-add
 "A d" #'appt-delete

 "H m" #'cal-html-cursor-month
 "H y" #'cal-html-cursor-year

 "g C" #'calendar-chinese-goto-date
 "g D" #'calendar-goto-day-of-year
 "g a" #'calendar-astro-goto-day-number
 "g b" #'calendar-bahai-goto-date
 "g c" #'calendar-iso-goto-date
 "g d" #'calendar-goto-date
 "g e" #'calendar-ethiopic-goto-date
 "g f" #'calendar-french-goto-date
 "g h" #'calendar-hebrew-goto-date
 "g i" #'calendar-islamic-goto-date
 "g j" #'calendar-julian-goto-date
 "g k" #'calendar-coptic-goto-date
 "g p" #'calendar-persian-goto-date
 "g w" #'calendar-iso-goto-week

 "i a" #'diary-insert-anniversary-entry
 "i b" #'diary-insert-block-entry
 "i c" #'diary-insert-cyclic-entry
 "i d" #'diary-insert-entry
 "i m" #'diary-insert-monthly-entry
 "i w" #'diary-insert-weekly-entry
 "i y" #'diary-insert-yearly-entry

 "p C" #'calendar-chinese-print-date
 "p a" #'calendar-astro-print-day-number
 "p b" #'calendar-bahai-print-date
 "p c" #'calendar-iso-print-date
 "p d" #'calendar-print-day-of-year
 "p e" #'calendar-ethiopic-print-date
 "p f" #'calendar-french-print-date
 "p h" #'calendar-hebrew-print-date
 "p i" #'calendar-islamic-print-date
 "p j" #'calendar-julian-print-date
 "p k" #'calendar-coptic-print-date
 "p m" #'calendar-mayan-print-date
 "p o" #'calendar-print-other-dates
 "p p" #'calendar-persian-print-date

 "t M" #'cal-tex-cursor-month-landscape
 "t Y" #'cal-tex-cursor-year-landscape
 "t d" #'cal-tex-cursor-day
 "t m" #'cal-tex-cursor-month
 "t y" #'cal-tex-cursor-year

 "t f W" #'cal-tex-cursor-filofax-week
 "t f d" #'cal-tex-cursor-filofax-daily
 "t f w" #'cal-tex-cursor-filofax-2week
 "t f y" #'cal-tex-cursor-filofax-year

 "t w 1" #'cal-tex-cursor-week
 "t w 2" #'cal-tex-cursor-week2
 "t w 3" #'cal-tex-cursor-week-iso
 "t w 4" #'cal-tex-cursor-week-monday
 "t w W" #'cal-tex-cursor-week2-summary)
#+END_SRC


* Org Clock
:PROPERTIES:
:PACKAGE:  org-clock
:END:
** Config :config:
#+BEGIN_SRC emacs-lisp
(defun kwrooijen/org-clock--today-range ()
  "Return (START . END) of today in Unix seconds."
  (let* ((now (decode-time (current-time)))
         (start (float-time
                 (encode-time 0 0 0
                              (nth 3 now)
                              (nth 4 now)
                              (nth 5 now)))))
    (cons start (+ start 86400))))


(defun kwrooijen/org-clock--today-start ()
  "Return Unix time (seconds) for start of today."
  (let* ((now (decode-time (current-time))))
    (encode-time 0 0 0
                 (nth 3 now)   ; day
                 (nth 4 now)   ; month
                 (nth 5 now)))) ; year

(defun kwrooijen/org-clock--open-clocked-today ()
  "Return minutes from currently running clocks that fall within today.
Uses org-clock-multi-clocks for multiple simultaneous clocks.
Note: Clock start times are stored in minutes since epoch."
  (let ((total 0))
    ;; Convert day boundaries to minutes for consistent comparison
    (pcase-let* ((`(,day-start-sec . ,day-end-sec) (kwrooijen/org-clock--today-range))
                 (day-start (floor (/ day-start-sec 60)))
                 (day-end (floor (/ day-end-sec 60)))
                 (now (floor (/ (float-time (current-time)) 60))))
      (dolist (clock org-clock-multi-clocks)
        (let ((clock-start (cdr clock)))  ; already in minutes
          (when (< clock-start day-end)
            (setq total (+ total
                           (max 0 (- (min now day-end)
                                     (max clock-start day-start)))))))))
    (when (> total 0) total)))

(defun kwrooijen/org-clock-clocked-today (&optional as-duration)
  "Return total time clocked today across `org-agenda-files`.
If AS-DURATION is non-nil, return an Org duration string."
  (let* ((start (float-time (kwrooijen/org-clock--today-start)))
         (end   (+ start 86400))
         (minutes (or (kwrooijen/org-clock--open-clocked-today) 0)))
    (dolist (file (org-agenda-files))
      (with-current-buffer (find-file-noselect file)
        (save-restriction
          (widen)
          (setq minutes
                (+ minutes (org-clock-sum start end))))))
    (if as-duration
        (org-duration-from-minutes minutes)
      minutes)))
#+END_SRC
